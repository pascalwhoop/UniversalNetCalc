#!/usr/bin/env node
import { readdir, readFile, writeFile, mkdir } from 'fs/promises'
import { join, dirname } from 'path'
import { parse } from 'yaml'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const rootDir = join(__dirname, '..')

async function bundleConfigs() {
  const configsPath = join(rootDir, 'configs')
  const outputPath = join(rootDir, '.generated')
  const bundle = {}

  console.log('ğŸ“¦ Bundling all configs into single JSON...')

  const countries = await readdir(configsPath, { withFileTypes: true })

  for (const countryEntry of countries) {
    if (!countryEntry.isDirectory()) continue

    const country = countryEntry.name
    const countryPath = join(configsPath, country)
    const years = await readdir(countryPath, { withFileTypes: true })

    bundle[country] = {}

    for (const yearEntry of years) {
      if (!yearEntry.isDirectory()) continue

      const year = yearEntry.name
      const yearPath = join(countryPath, year)

      bundle[country][year] = {}

      // Load base.yaml
      const basePath = join(yearPath, 'base.yaml')
      const baseYaml = await readFile(basePath, 'utf-8')
      bundle[country][year].base = parse(baseYaml)

      console.log(`  âœ“ ${country}/${year}/base`)

      // Load variants
      const variantsPath = join(yearPath, 'variants')
      try {
        const variantFiles = await readdir(variantsPath)
        bundle[country][year].variants = {}

        for (const variantFile of variantFiles) {
          if (variantFile.endsWith('.yaml')) {
            const variantName = variantFile.replace('.yaml', '')
            const variantYaml = await readFile(join(variantsPath, variantFile), 'utf-8')
            bundle[country][year].variants[variantName] = parse(variantYaml)
            console.log(`  âœ“ ${country}/${year}/variants/${variantName}`)
          }
        }
      } catch {
        // No variants directory
        bundle[country][year].variants = {}
      }
    }
  }

  // Ensure output directory exists
  await mkdir(outputPath, { recursive: true })

  // Write bundle as TypeScript module
  const tsContent = `// Auto-generated config bundle
// Do not edit this file directly - run 'npm run build:configs' to regenerate

export const configBundle = ${JSON.stringify(bundle, null, 2)} as const

export default configBundle
`

  await writeFile(join(outputPath, 'config-bundle.ts'), tsContent, 'utf-8')

  // Calculate stats
  const configCount = Object.entries(bundle).reduce((sum, [, years]) => {
    return sum + Object.entries(years).reduce((yearSum, [, data]) => {
      return yearSum + 1 + Object.keys(data.variants || {}).length
    }, 0)
  }, 0)

  console.log(`âœ… Bundled ${configCount} configs successfully!`)
}

bundleConfigs().catch((error) => {
  console.error('âŒ Bundle failed:', error)
  process.exit(1)
})
