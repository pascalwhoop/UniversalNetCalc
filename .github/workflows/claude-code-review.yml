name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    # Skip draft PRs and PRs from bots (except our own agent PRs)
    if: |
      github.event.pull_request.draft == false &&
      (
        github.event.pull_request.user.login != 'dependabot[bot]'
      )

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Count review rounds
        id: review-count
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            const reviewComments = comments.data.filter(c =>
              c.body.includes('<!-- claude-reviewer -->'),
            );
            const round = reviewComments.length + 1;
            core.setOutput('round', round);
            core.setOutput('is_final_round', round >= 3 ? 'true' : 'false');

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Run Claude Adversarial Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          CLAUDE_CODE_USE_VERTEX: "1"
          ANTHROPIC_VERTEX_PROJECT_ID: ${{ secrets.ANTHROPIC_VERTEX_PROJECT_ID }}
          CLOUD_ML_REGION: "global"
          OVERRIDE_GITHUB_TOKEN: ${{ secrets.PM_AGENT_TOKEN }}
        with:
          use_vertex: true
          github_token: ${{ secrets.PM_AGENT_TOKEN }}
          additional_permissions: |
            actions: read
          claude_args: '--max-turns 100'
          allowed_tools: 'Bash,Edit,MultiEdit,Glob,Grep,LS,Read,Write,mcp__github_comment__update_claude_comment'
          prompt: |
            /reviewer

            You are conducting review round ${{ steps.review-count.outputs.round }} of this PR.
            Final round (approve regardless after this): ${{ steps.review-count.outputs.is_final_round }}

            Follow your reviewer skill instructions precisely. After posting your review,
            add a comment starting with <!-- claude-reviewer --> to track review rounds.

            If this is the final round, approve the PR with any remaining minor concerns noted
            rather than requesting more changes.
