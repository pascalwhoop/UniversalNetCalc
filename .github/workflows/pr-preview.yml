name: PR Preview

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-permission:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/release-preview')
    outputs:
      has-permission: ${{ steps.check.outputs.has-permission }}
    steps:
      - name: Check user has write access
        id: check
        run: |
          # Check if user has write permission
          if [ "${{ github.event.comment.author_association }}" = "OWNER" ] || \
             [ "${{ github.event.comment.author_association }}" = "COLLABORATOR" ] || \
             [ "${{ github.event.comment.author_association }}" = "MEMBER" ]; then
            echo "has-permission=true" >> $GITHUB_OUTPUT
          else
            echo "has-permission=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-permission
    if: needs.check-permission.outputs.has-permission == 'true'
    environment:
      name: preview
    steps:
      - name: Get PR info
        id: pr
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "worker-name=universal-net-calc-pr-$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: make install

      - name: Build for Cloudflare
        run: make build-cloudflare

      - name: Deploy PR preview
        run: npx wrangler deploy --name ${{ steps.pr.outputs.worker-name }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Enable workers.dev subdomain
        run: |
          curl -s -X PUT \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"enabled": true}' \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/${{ steps.pr.outputs.worker-name }}/subdomain"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = `https://universal-net-calc-pr-${prNumber}.reconnct.workers.dev`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ PR preview deployed!\n\n[üîó Preview Link](${previewUrl})\n\n_This preview will be available for testing until the PR is closed._`
            });

      - name: Handle permission denied
        if: ${{ failure() && needs.check-permission.outputs.has-permission == 'false' }}
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå You don't have permission to trigger PR previews. Only collaborators can use the \`/release-preview\` command.`
            });
