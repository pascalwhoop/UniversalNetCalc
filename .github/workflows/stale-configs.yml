name: Detect Stale Configs

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st at 00:00 UTC
  workflow_dispatch:

jobs:
  detect-stale:
    runs-on: ubuntu-latest
    name: Find Outdated Configs
    steps:
      - uses: actions/checkout@v4

      - name: Find configs older than 2 years
        id: find-old
        run: |
          CURRENT_YEAR=$(date +%Y)
          CUTOFF_YEAR=$((CURRENT_YEAR - 2))

          echo "Searching for configs older than $CUTOFF_YEAR..."

          OLD_CONFIGS=""
          while IFS= read -r dir; do
            YEAR=$(basename "$dir")
            if [[ "$YEAR" =~ ^[0-9]{4}$ ]] && [ "$YEAR" -le "$CUTOFF_YEAR" ]; then
              if [ -z "$OLD_CONFIGS" ]; then
                OLD_CONFIGS="$dir"
              else
                OLD_CONFIGS="$OLD_CONFIGS"$'\n'"$dir"
              fi
            fi
          done < <(find configs -type d -name "[0-9][0-9][0-9][0-9]" 2>/dev/null | sort)

          if [ -n "$OLD_CONFIGS" ]; then
            echo "$OLD_CONFIGS" > old-configs.txt
            echo "found-stale=true" >> "$GITHUB_OUTPUT"
          else
            echo "found-stale=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue if stale configs found
        if: steps.find-old.outputs.found-stale == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const oldConfigs = fs.readFileSync('old-configs.txt', 'utf8').trim();

            if (oldConfigs) {
              const configList = oldConfigs
                .split('\n')
                .map(c => `- \`${c}\``)
                .join('\n');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üóÑÔ∏è Outdated configs detected',
                body: `The following configs are older than 2 years and may need archiving:\n\n${configList}\n\n## Suggested Actions\n- Archive old configs if tax laws haven't changed\n- Add deprecation notices in meta.deprecated\n- Update documentation to direct users to newer configs\n- Consider deleting if they are no longer relevant\n\nReview each config's tax situation before archiving.`,
                labels: ['maintenance', 'configs'],
                assignees: []
              });

              console.log(`Created issue for ${oldConfigs.split('\n').length} stale configs`);
            }
