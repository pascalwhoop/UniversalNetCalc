name: Welcome Contributors

on:
  pull_request_target:
    types: [opened]

jobs:
  welcome:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check if first-time contributor
        id: first-time
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            const repoOwner = context.repo.owner;

            // Get all commits by this author in the repo
            try {
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                author: author,
                per_page: 1
              });

              // If this is their first PR, they won't have commits yet
              // But we check if they have any PRs merged
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                creator: author
              });

              const mergedPRs = prs.data.filter(pr => pr.merged_at !== null).length;
              core.setOutput('is-first-time', mergedPRs === 0 ? 'true' : 'false');
            } catch (error) {
              core.setOutput('is-first-time', 'true');
            }

      - name: Post welcome message
        if: steps.first-time.outputs.is-first-time == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prType = context.payload.pull_request.title.toLowerCase().includes('config')
              ? 'config contribution'
              : 'code contribution';

            let message = `ğŸ‘‹ **Welcome and thank you for your ${prType}!**\n\n`;
            message += `A maintainer will review your PR soon. In the meantime:\n`;
            message += `- âœ… Make sure all CI checks pass (they run automatically)\n`;
            message += `- ğŸ“š Review our [contribution guidelines](docs/contributing.md)\n`;

            if (prType === 'config contribution') {
              message += `- ğŸ’¡ Ensure you have at least 3 test vectors (low/median/high income)\n`;
              message += `- ğŸ” Check that all sources are cited in the config meta section\n`;
            } else {
              message += `- ğŸ’¡ Ensure all tests pass locally before pushing\n`;
              message += `- ğŸ” For configs affected, run \`npm run test:configs\` locally\n`;
            }

            message += `\nQuestions? Feel free to ask in the comments!`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
